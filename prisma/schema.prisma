generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Deal {
  id          String    @id @default(uuid())
  clientName  String
  clientPhone String?
  notes       String?
  stage       DealStage @default(NEW_LEAD)
  dealType    DealType  @default(SALE)
  amount      Decimal?  @db.Decimal(12, 2)
  propertyId  String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  property    Property  @relation(fields: [propertyId], references: [id])
  
  // Rental management fields (only used when dealType = RENT)
  leaseStartDate  DateTime?
  leaseEndDate    DateTime?
  monthlyRent     Decimal?  @db.Decimal(12, 2)
  depositAmount   Decimal?  @db.Decimal(12, 2)
  nextPaymentDue  DateTime?
}

enum DealType {
  SALE
  RENT
}

model Project {
  id             String           @id @default(uuid())
  name           String
  type           PropertyCategory
  address        String
  city           String
  lat            Decimal          @db.Decimal(10, 8)
  lng            Decimal          @db.Decimal(11, 8)
  developer      String?
  completionYear Int?
  description    String?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  totalUnits     Int?
  totalBuildings Int?
  totalFloors    Int?
  imageUrl       String?
  facilities     Facility[]
  modelAsset     ModelAsset?
  units          Property[]

  @@index([name])
  @@index([type])
  @@index([city])
  @@index([address])
}

model ModelAsset {
  id        String  @id @default(uuid())
  glbUrl    String
  placement Json    @default("{}")
  projectId String  @unique
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model Facility {
  id        String  @id @default(uuid())
  name      String
  imageUrl  String?
  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model Property {
  id                    String              @id @default(uuid())
  title                 String
  description           String
  price                 Decimal?            @db.Decimal(12, 2)
  address               String
  city                  String
  state                 String
  zipCode               String
  category              PropertyCategory
  houseType             HouseType?
  projectName           String?
  floor                 Int?
  investmentType        InvestmentType?
  openForYears          Int?
  equipmentIncluded     EquipmentLevel?
  numberOfStaff         Int?
  monthlyRevenue        Decimal?            @db.Decimal(12, 2)
  license               Boolean?
  bedrooms              Int?
  bathrooms             Int?
  size                  Int
  petFriendly           Boolean?
  parking               Int?
  furnished             Boolean?
  garden                Boolean?
  pool                  Boolean?
  floors                Int?
  amenities             Json?
  status                PropertyStatus      @default(AVAILABLE)
  listingType           ListingType         @default(SALE)
  images                String[]
  featured              Boolean             @default(false)
  latitude              Decimal?            @db.Decimal(10, 8)
  longitude             Decimal?            @db.Decimal(11, 8)
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  lastVerifiedAt        DateTime            @default(now())
  ownerContactDetails   String?
  ownerContactMethod    ContactMethod?
  verificationSource    VerificationSource?
  rentPrice             Decimal?            @db.Decimal(12, 2)
  conferenceRoom        Boolean?
  area                  String?
  projectId             String?
  landZoneColor         LandZoneColor?
  coAgentCommissionRate Decimal?            @db.Decimal(5, 2)
  commissionAmount      Decimal?            @db.Decimal(12, 2)
  commissionRate        Decimal?            @db.Decimal(5, 2) // Platform commission (internal only)
  agentCommissionRate   Decimal?            @db.Decimal(5, 2) // Shared commission (visible to all agents)
  agentId               String?             // Listing agent
  
  // Internal rental tracking (platform agents only)
  rentedUntil           DateTime?           // Lease end date
  availableFrom         DateTime?           // When property becomes available again
  
  deals                 Deal[]
  project               Project?            @relation(fields: [projectId], references: [id])

  @@index([city])
  @@index([agentId])
  @@index([status])
  @@index([featured])
  @@index([category])
  @@index([houseType])
  @@index([investmentType])
  @@index([landZoneColor])
  @@index([listingType])
  @@index([rentedUntil])
  @@index([availableFrom])
}

model Contact {
  id        String   @id @default(uuid())
  name      String
  email     String
  phone     String?
  message   String
  createdAt DateTime @default(now())

  @@index([createdAt])
}

model PropertySubmission {
  id           String           @id @default(uuid())
  contactName  String
  contactLine  String?
  contactPhone String?
  title        String
  description  String
  price        Decimal          @db.Decimal(12, 2)
  listingType  ListingType
  category     PropertyCategory
  address      String?
  city         String?
  state        String?
  commission   String?
  images       String[]
  status       String           @default("PENDING")
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
}

model Post {
  id         String       @id @default(uuid())
  title      String
  excerpt    String?
  content    String
  category   PostCategory
  coverImage String?
  published  Boolean      @default(false)
  authorName String?
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt

  @@index([category])
  @@index([published])
}

model AgentProfile {
  id          String    @id @default(uuid())
  name        String
  email       String?
  phone       String?
  lineId      String?
  whatsapp    String?
  imageUrl    String?
  languages   String[]
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  role        UserRole  @default(AGENT)
  companyName String?
  enquiries   Enquiry[]
}

// ============================================
// PRICE HISTORY - Track all price changes
// ============================================
model PriceHistory {
  id          String   @id @default(uuid())
  propertyId  String
  price       Decimal? @db.Decimal(12, 2)
  rentPrice   Decimal? @db.Decimal(12, 2)
  changeType  PriceChangeType
  changedAt   DateTime @default(now())
  changedBy   String?  // Agent ID who made the change
  notes       String?  // Optional reason for change
  
  @@index([propertyId])
  @@index([changedAt])
}

enum PriceChangeType {
  INITIAL      // First listing price
  INCREASE     // Price went up
  DECREASE     // Price went down (for alerts)
  CORRECTION   // Data correction
}

// ============================================
// ENQUIRY - Track all contact requests
// ============================================
model Enquiry {
  id           String        @id @default(uuid())
  propertyId   String
  channel      EnquiryChannel
  name         String?
  phone        String?
  email        String?
  message      String?
  status       EnquiryStatus @default(NEW)
  agentId      String?
  agent        AgentProfile? @relation(fields: [agentId], references: [id])
  createdAt    DateTime      @default(now())
  respondedAt  DateTime?
  
  @@index([propertyId])
  @@index([agentId])
  @@index([channel])
  @@index([createdAt])
}

enum EnquiryChannel {
  LINE
  WHATSAPP
  PHONE
  EMAIL
  WEBSITE_FORM
}

enum EnquiryStatus {
  NEW
  CONTACTED
  CONVERTED
  CLOSED
}

// ============================================
// SOLD PROPERTY - Archive of completed sales/rentals
// ============================================
model SoldProperty {
  id                String           @id @default(uuid())
  // Original property data (snapshot)
  originalId        String           // Original property ID for reference
  title             String
  description       String?
  category          PropertyCategory
  houseType         HouseType?
  investmentType    InvestmentType?
  address           String
  city              String
  area              String?
  projectName       String?
  projectId         String?
  bedrooms          Int?
  bathrooms         Int?
  size              Int
  floor             Int?
  latitude          Decimal?         @db.Decimal(10, 8)
  longitude         Decimal?         @db.Decimal(11, 8)
  images            String[]
  
  // Listing prices (what it was listed for)
  listingPrice      Decimal?         @db.Decimal(12, 2)
  listingRentPrice  Decimal?         @db.Decimal(12, 2)
  listingType       ListingType
  
  // Final transaction data
  soldType          SoldType
  finalPrice        Decimal?         @db.Decimal(12, 2)  // Actual sale/rent price
  soldAt            DateTime         @default(now())
  daysOnMarket      Int?             // How long it took to sell
  
  // Agent/commission data
  agentId           String?
  commissionEarned  Decimal?         @db.Decimal(12, 2)
  
  // Metadata
  listedAt          DateTime?        // When it was first listed
  createdAt         DateTime         @default(now())
  notes             String?
  
  @@index([city])
  @@index([area])
  @@index([category])
  @@index([soldAt])
  @@index([projectId])
  @@index([soldType])
}

enum SoldType {
  SOLD           // Property was sold
  RENTED         // Property was rented
  WITHDRAWN      // Owner withdrew listing
  EXPIRED        // Listing expired without sale
  OFF_MARKET     // Taken off market (other reason)
}

// ============================================
// AREA STATS - Pre-aggregated data for heatmaps
// ============================================
model AreaStats {
  id                  String           @id @default(uuid())
  city                String
  area                String?          // Sub-area/district
  category            PropertyCategory
  
  // Price metrics (updated periodically)
  avgPricePerSqm      Decimal?         @db.Decimal(12, 2)
  medianPricePerSqm   Decimal?         @db.Decimal(12, 2)
  minPricePerSqm      Decimal?         @db.Decimal(12, 2)
  maxPricePerSqm      Decimal?         @db.Decimal(12, 2)
  
  // Rent metrics
  avgRentPerSqm       Decimal?         @db.Decimal(12, 2)
  avgRentalYield      Decimal?         @db.Decimal(5, 2)
  
  // Volume metrics
  activeListings      Int              @default(0)
  soldLast30Days      Int              @default(0)
  soldLast90Days      Int              @default(0)
  avgDaysOnMarket     Int?
  
  // Demand metrics (for future use)
  enquiriesLast30Days Int              @default(0)
  viewsLast30Days     Int              @default(0)
  
  // Trend data
  priceChange30Days   Decimal?         @db.Decimal(5, 2)  // % change
  priceChange90Days   Decimal?         @db.Decimal(5, 2)
  
  // Geo data for heatmap rendering
  centerLat           Decimal?         @db.Decimal(10, 8)
  centerLng           Decimal?         @db.Decimal(11, 8)
  boundaryPolygon     Json?            // GeoJSON polygon for area boundary
  
  lastUpdated         DateTime         @default(now())
  
  @@unique([city, area, category])
  @@index([city])
  @@index([category])
}

enum PropertyCategory {
  HOUSE
  CONDO
  INVESTMENT
  LAND
}

enum HouseType {
  SINGLE_HOUSE
  POOL_VILLA
  TOWNHOUSE
  SHOPHOUSE
}

enum InvestmentType {
  HOTEL
  CLUB_BAR
  MASSAGE
  RESTAURANT
  WELLNESS
}

enum LandZoneColor {
  RED
  ORANGE
  YELLOW
  BROWN
  PURPLE
  GREEN
}

enum EquipmentLevel {
  FULLY
  PARTIAL
  JUST_STRUCTURE
}

enum PropertyStatus {
  AVAILABLE
  PENDING
  SOLD
  RENTED
  EXPIRED
}

enum ListingType {
  SALE
  RENT
  BOTH
}

enum VerificationSource {
  MANUAL
  OWNER
  SYSTEM
}

enum ContactMethod {
  LINE
  EMAIL
  PHONE
}

enum DealStage {
  NEW_LEAD
  VIEWING
  OFFER
  CONTRACT
  CLOSED
}

enum UserRole {
  SUPER_ADMIN
  PLATFORM_AGENT
  AGENT
}

enum PostCategory {
  MARKET_TREND
  INVESTMENT
  LEGAL
  NEWS
}
