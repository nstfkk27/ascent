generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Deal {
  id          String    @id @default(uuid())
  clientName  String
  clientPhone String?
  notes       String?
  stage       DealStage @default(NEW_LEAD)
  dealType    DealType  @default(SALE)
  amount      Decimal?  @db.Decimal(12, 2)
  propertyId  String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  property    Property  @relation(fields: [propertyId], references: [id])
  
  // Rental management fields (only used when dealType = RENT)
  leaseStartDate  DateTime?
  leaseEndDate    DateTime?
  monthlyRent     Decimal?  @db.Decimal(12, 2)
  depositAmount   Decimal?  @db.Decimal(12, 2)
  nextPaymentDue  DateTime?
}

enum DealType {
  SALE
  RENT
}

model Project {
  id             String           @id @default(uuid())
  name           String
  nameTh         String?          // Thai name for bilingual support
  type           PropertyCategory
  address        String
  city           String
  lat            Decimal          @db.Decimal(10, 8)
  lng            Decimal          @db.Decimal(11, 8)
  developer      String?
  completionYear Int?
  description    String?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  totalUnits     Int?
  totalBuildings Int?
  totalFloors    Int?
  imageUrl       String?
  facilities     Facility[]
  modelAsset     ModelAsset?
  units          Property[]

  @@index([name])
  @@index([nameTh])
  @@index([type])
  @@index([city])
  @@index([address])
}

model ModelAsset {
  id        String  @id @default(uuid())
  glbUrl    String
  placement Json    @default("{}")
  projectId String  @unique
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model Facility {
  id        String  @id @default(uuid())
  name      String
  imageUrl  String?
  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model Property {
  id                    String              @id @default(uuid())
  referenceId           String              @unique
  slug                  String              @unique
  title                 String
  description           String
  price                 Decimal?            @db.Decimal(12, 2)
  address               String
  city                  String
  state                 String
  zipCode               String
  category              PropertyCategory
  houseType             HouseType?
  projectName           String?
  floor                 Int?
  investmentType        InvestmentType?
  equipmentIncluded     EquipmentLevel?
  numberOfStaff         Int?
  monthlyRevenue        Decimal?            @db.Decimal(12, 2)
  license               Boolean?
  bedrooms              Int?
  bathrooms             Int?
  isStudio              Boolean?            // For condos - if true, bedrooms = 0
  size                  Int
  petFriendly           Boolean?            // For HOUSE/CONDO only
  parking               Int?
  furnished             Boolean?            // For HOUSE/CONDO only
  floors                Int?
  amenities             Json?               // Stores pool, garden, and all other amenities
  status                PropertyStatus      @default(AVAILABLE)
  listingType           ListingType         @default(SALE)
  images                String[]
  featured              Boolean             @default(false)
  latitude              Decimal?            @db.Decimal(10, 8)
  longitude             Decimal?            @db.Decimal(11, 8)
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  lastVerifiedAt        DateTime            @default(now())
  ownerContactDetails   String?
  ownerContactMethod    ContactMethod?
  verificationSource    VerificationSource?
  rentPrice             Decimal?            @db.Decimal(12, 2)
  conferenceRoom        Boolean?
  area                  String?
  projectId             String?
  landZoneColor         LandZoneColor?
  highlights            String[]            // Property & Area highlights (e.g., NEAR_BEACH, SEA_VIEW)
  
  // Commission Structure (Simple)
  agentCommissionRate   Decimal?            @db.Decimal(5, 2) // Commission % offered to other agents
  commissionAmount      Decimal?            @db.Decimal(12, 2) // OR fixed commission amount
  agentId               String?             // Listing agent
  
  // ============================================
  // INTELLIGENCE DATA - Internal only (SUPER_ADMIN, PLATFORM_AGENT)
  // ============================================
  
  // Calculated metrics (auto-computed)
  pricePerSqm           Decimal?            @db.Decimal(12, 2)
  estimatedRentalYield  Decimal?            @db.Decimal(5, 2)
  
  // Market intelligence
  fairValueEstimate     Decimal?            @db.Decimal(12, 2)
  priceDeviation        Decimal?            @db.Decimal(5, 2)
  dealQuality           DealQuality?
  
  // Lead intelligence
  viewCount             Int                 @default(0)
  enquiryCount          Int                 @default(0)
  leadScore             Int?
  
  // Internal operations
  internalNotes         String?
  lastIntelligenceUpdate DateTime?
  
  // Rental tracking
  rentedOn              DateTime?           // Lease start date
  rentedUntil           DateTime?           // Lease end date
  
  // Sale tracking
  soldOn                DateTime?           // Transaction date
  soldPrice             Decimal?            @db.Decimal(12, 2) // Actual sale price (defaults to asking price if empty)
  
  // ============================================
  // AI SEARCH & LOCATION INTELLIGENCE
  // ============================================
  searchSummary         String?             // AI-generated keyword-rich summary
  
  // Nearest POI distances (auto-calculated from PropertyPOIDistance)
  subArea               String?             // "Jomtien Beach", "Walking Street Area"
  nearestBeachKm        Decimal?            @db.Decimal(5, 2)
  nearestBeachName      String?
  nearestMallKm         Decimal?            @db.Decimal(5, 2)
  nearestMallName       String?
  nearestHospitalKm     Decimal?            @db.Decimal(5, 2)
  nearestHospitalName   String?
  nearestSchoolKm       Decimal?            @db.Decimal(5, 2)
  nearestSchoolName     String?
  
  // Market comparison context
  projectAvgPricePerSqm Decimal?            @db.Decimal(12, 2)
  areaAvgPricePerSqm    Decimal?            @db.Decimal(12, 2)
  priceVsProjectAvg     Decimal?            @db.Decimal(5, 2)  // -15 = 15% below project avg
  priceVsAreaAvg        Decimal?            @db.Decimal(5, 2)  // -10 = 10% below area avg
  
  // Quality scoring (0-100)
  locationScore         Int?
  valueScore            Int?
  investmentScore       Int?
  overallScore          Int?
  
  // AI-generated tags
  keyFeatures           String[]            // ["Sea view", "Below market", "High yield"]
  targetBuyer           String[]            // ["Investor", "Retiree", "Family"]
  
  deals                 Deal[]
  project               Project?            @relation(fields: [projectId], references: [id])

  @@index([referenceId])
  @@index([slug])
  @@index([city])
  @@index([agentId])
  @@index([status])
  @@index([featured])
  @@index([category])
  @@index([houseType])
  @@index([investmentType])
  @@index([landZoneColor])
  @@index([listingType])
  @@index([rentedOn])
  @@index([rentedUntil])
  @@index([soldOn])
  @@index([dealQuality])
  @@index([leadScore])
  @@index([pricePerSqm])
  @@index([subArea])
  @@index([nearestBeachKm])
  @@index([nearestMallKm])
  @@index([priceVsAreaAvg])
  @@index([overallScore])
  @@index([investmentScore])
}

model Contact {
  id        String   @id @default(uuid())
  name      String
  email     String
  phone     String?
  message   String
  createdAt DateTime @default(now())

  @@index([createdAt])
}

model PropertySubmission {
  id           String           @id @default(uuid())
  contactName  String
  contactLine  String?
  contactPhone String?
  title        String
  description  String
  price        Decimal          @db.Decimal(12, 2)
  listingType  ListingType
  category     PropertyCategory
  address      String?
  city         String?
  state        String?
  commission   String?
  images       String[]
  status       String           @default("PENDING")
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
}

model Post {
  id         String       @id @default(uuid())
  slug       String       @unique
  title      String
  excerpt    String?
  content    String
  category   PostCategory
  coverImage String?
  published  Boolean      @default(false)
  authorId   String?      // AgentProfile ID of author
  authorName String?
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt

  @@index([slug])
  @@index([category])
  @@index([published])
  @@index([createdAt])
}

model AgentProfile {
  id          String    @id @default(uuid())
  name        String
  email       String?
  phone       String?
  lineId      String?
  whatsapp    String?
  imageUrl    String?
  languages   String[]
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  role        UserRole  @default(AGENT)
  companyName String?
  enquiries   Enquiry[]
}

// ============================================
// PRICE HISTORY - Track all price changes
// ============================================
model PriceHistory {
  id          String   @id @default(uuid())
  propertyId  String
  price       Decimal? @db.Decimal(12, 2)
  rentPrice   Decimal? @db.Decimal(12, 2)
  changeType  PriceChangeType
  changedAt   DateTime @default(now())
  changedBy   String?  // Agent ID who made the change
  notes       String?  // Optional reason for change
  
  @@index([propertyId])
  @@index([changedAt])
}

enum PriceChangeType {
  INITIAL      // First listing price
  INCREASE     // Price went up
  DECREASE     // Price went down (for alerts)
  CORRECTION   // Data correction
}

// ============================================
// ENQUIRY - Track all contact requests
// ============================================
model Enquiry {
  id           String        @id @default(uuid())
  propertyId   String
  channel      EnquiryChannel
  name         String?
  phone        String?
  email        String?
  message      String?
  status       EnquiryStatus @default(NEW)
  agentId      String?
  agent        AgentProfile? @relation(fields: [agentId], references: [id])
  createdAt    DateTime      @default(now())
  respondedAt  DateTime?
  
  @@index([propertyId])
  @@index([agentId])
  @@index([channel])
  @@index([createdAt])
}

enum EnquiryChannel {
  LINE
  WHATSAPP
  PHONE
  EMAIL
  WEBSITE_FORM
}

enum EnquiryStatus {
  NEW
  CONTACTED
  CONVERTED
  CLOSED
}

// ============================================
// SOLD PROPERTY - Archive of completed sales/rentals
// ============================================
model SoldProperty {
  id                String           @id @default(uuid())
  // Original property data (snapshot)
  originalId        String           // Original property ID for reference
  title             String
  description       String?
  category          PropertyCategory
  houseType         HouseType?
  investmentType    InvestmentType?
  address           String
  city              String
  area              String?
  projectName       String?
  projectId         String?
  bedrooms          Int?
  bathrooms         Int?
  size              Int
  floor             Int?
  latitude          Decimal?         @db.Decimal(10, 8)
  longitude         Decimal?         @db.Decimal(11, 8)
  images            String[]
  
  // Listing prices (what it was listed for)
  listingPrice      Decimal?         @db.Decimal(12, 2)
  listingRentPrice  Decimal?         @db.Decimal(12, 2)
  listingType       ListingType
  
  // Final transaction data
  soldType          SoldType
  finalPrice        Decimal?         @db.Decimal(12, 2)  // Actual sale/rent price
  soldAt            DateTime         @default(now())
  daysOnMarket      Int?             // How long it took to sell
  
  // Agent/commission data
  agentId           String?
  commissionEarned  Decimal?         @db.Decimal(12, 2)
  
  // Metadata
  listedAt          DateTime?        // When it was first listed
  createdAt         DateTime         @default(now())
  notes             String?
  
  @@index([city])
  @@index([area])
  @@index([category])
  @@index([soldAt])
  @@index([projectId])
  @@index([soldType])
}

enum SoldType {
  SOLD           // Property was sold
  RENTED         // Property was rented
  WITHDRAWN      // Owner withdrew listing
  EXPIRED        // Listing expired without sale
  OFF_MARKET     // Taken off market (other reason)
}

// ============================================
// AREA STATS - Pre-aggregated data for heatmaps
// ============================================
model AreaStats {
  id                  String           @id @default(uuid())
  city                String
  area                String?          // Sub-area/district
  category            PropertyCategory
  
  // Price metrics (updated periodically)
  avgPricePerSqm      Decimal?         @db.Decimal(12, 2)
  medianPricePerSqm   Decimal?         @db.Decimal(12, 2)
  minPricePerSqm      Decimal?         @db.Decimal(12, 2)
  maxPricePerSqm      Decimal?         @db.Decimal(12, 2)
  
  // Rent metrics
  avgRentPerSqm       Decimal?         @db.Decimal(12, 2)
  avgRentalYield      Decimal?         @db.Decimal(5, 2)
  
  // Volume metrics
  activeListings      Int              @default(0)
  soldLast30Days      Int              @default(0)
  soldLast90Days      Int              @default(0)
  avgDaysOnMarket     Int?
  
  // Demand metrics (for future use)
  enquiriesLast30Days Int              @default(0)
  viewsLast30Days     Int              @default(0)
  
  // Trend data
  priceChange30Days   Decimal?         @db.Decimal(5, 2)  // % change
  priceChange90Days   Decimal?         @db.Decimal(5, 2)
  
  // Geo data for heatmap rendering
  centerLat           Decimal?         @db.Decimal(10, 8)
  centerLng           Decimal?         @db.Decimal(11, 8)
  boundaryPolygon     Json?            // GeoJSON polygon for area boundary
  
  lastUpdated         DateTime         @default(now())
  
  @@unique([city, area, category])
  @@index([city])
  @@index([category])
}

enum PropertyCategory {
  HOUSE
  CONDO
  INVESTMENT
  LAND
}

enum HouseType {
  SINGLE_HOUSE
  POOL_VILLA
  TOWNHOUSE
  SHOPHOUSE
}

enum InvestmentType {
  HOTEL
  CLUB_BAR
  MASSAGE
  RESTAURANT
  WELLNESS
}

enum LandZoneColor {
  RED
  ORANGE
  YELLOW
  BROWN
  PURPLE
  GREEN
}

enum EquipmentLevel {
  FULLY
  PARTIAL
  JUST_STRUCTURE
}

enum PropertyStatus {
  AVAILABLE
  PENDING
  SOLD
  RENTED
  EXPIRED
}

enum ListingType {
  SALE
  RENT
  BOTH
}

enum VerificationSource {
  MANUAL
  OWNER
  SYSTEM
}

enum ContactMethod {
  LINE
  EMAIL
  PHONE
}

enum DealStage {
  NEW_LEAD
  VIEWING
  OFFER
  CONTRACT
  CLOSED
}

enum UserRole {
  SUPER_ADMIN
  PLATFORM_AGENT
  AGENT
}

enum PostCategory {
  LOCAL_NEWS
  LEGAL
  VISA
}

enum DealQuality {
  SUPER_DEAL      // >15% below fair value
  GOOD_VALUE      // 5-15% below fair value
  FAIR            // Within Â±5% of fair value
  OVERPRICED      // >5% above fair value
  HIGH_YIELD      // Rental yield > 6%
}

// ============================================
// WISHLIST - Save favorite properties
// ============================================
model Wishlist {
  id         String   @id @default(uuid())
  userId     String   // Can be Supabase user ID or session ID for guests
  propertyId String
  createdAt  DateTime @default(now())
  
  @@unique([userId, propertyId])
  @@index([userId])
  @@index([propertyId])
}

// ============================================
// COMPARISON - Track properties being compared
// ============================================
model Comparison {
  id         String   @id @default(uuid())
  userId     String   // Can be Supabase user ID or session ID for guests
  propertyId String
  createdAt  DateTime @default(now())
  
  @@unique([userId, propertyId])
  @@index([userId])
}

// ============================================
// PRICE ALERTS - Premium feature for tracking price changes
// ============================================
model PriceAlert {
  id                String   @id @default(uuid())
  userId            String   // Supabase user ID
  propertyId        String
  alertType         PriceAlertType @default(ANY_CHANGE)
  targetPrice       Decimal? @db.Decimal(12, 2) // Optional target price
  percentageChange  Int?     // Optional percentage threshold (e.g., 5 for 5%)
  isActive          Boolean  @default(true)
  lastNotifiedAt    DateTime?
  lastCheckedPrice  Decimal? @db.Decimal(12, 2)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@unique([userId, propertyId])
  @@index([userId])
  @@index([propertyId])
  @@index([isActive])
}

enum PriceAlertType {
  ANY_CHANGE      // Alert on any price change
  PRICE_DROP      // Alert only on price drops
  PRICE_INCREASE  // Alert only on price increases
  TARGET_PRICE    // Alert when price reaches target
  PERCENTAGE_DROP // Alert when price drops by X%
}

// ============================================
// PREMIUM FEATURES - Track feature access by role
// ============================================
model PremiumFeature {
  id          String   @id @default(uuid())
  name        String   @unique // e.g., "PRICE_ALERTS", "ADVANCED_ANALYTICS"
  displayName String
  description String?
  allowedRoles UserRole[] // Array of roles that can access this feature
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ============================================
// NOTIFICATIONS - Track notifications for users
// ============================================
model Notification {
  id         String   @id @default(uuid())
  userId     String
  type       NotificationType
  title      String
  message    String
  data       Json?    // Additional data (e.g., propertyId, oldPrice, newPrice)
  isRead     Boolean  @default(false)
  createdAt  DateTime @default(now())
  
  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}

enum NotificationType {
  PRICE_ALERT
  PROPERTY_UPDATE
  SYSTEM
  MARKETING
}

// ============================================
// POINTS OF INTEREST - For AI distance-based queries
// ============================================
model PointOfInterest {
  id          String      @id @default(uuid())
  name        String
  nameTh      String?
  type        POIType
  tier        POITier     @default(PRIMARY)
  latitude    Decimal     @db.Decimal(10, 8)
  longitude   Decimal     @db.Decimal(11, 8)
  city        String
  area        String?
  metadata    Json?
  isActive    Boolean     @default(true)
  createdAt   DateTime    @default(now())
  
  distances   PropertyPOIDistance[]
  
  @@index([type])
  @@index([tier])
  @@index([city])
  @@index([latitude, longitude])
}

enum POIType {
  BEACH
  HOSPITAL
  INTERNATIONAL_SCHOOL
  THAI_SCHOOL
  SHOPPING_MALL
  SUPERMARKET
  CONVENIENCE_STORE
  BTS_STATION
  MRT_STATION
  AIRPORT
  GOLF_COURSE
  PARK
  RESTAURANT_AREA
  NIGHTLIFE
  GYM
  TEMPLE
  IMMIGRATION
  EMBASSY
}

enum POITier {
  PRIMARY    // Major landmarks for search filters
  SECONDARY  // Convenience info only
}

// ============================================
// PRE-CALCULATED DISTANCES - For fast filtering
// ============================================
model PropertyPOIDistance {
  id          String           @id @default(uuid())
  propertyId  String
  poiId       String
  poiType     POIType
  distanceKm  Decimal          @db.Decimal(6, 3)
  walkingMins Int?
  drivingMins Int?
  
  poi         PointOfInterest  @relation(fields: [poiId], references: [id], onDelete: Cascade)
  
  @@unique([propertyId, poiId])
  @@index([propertyId])
  @@index([poiType])
  @@index([distanceKm])
}

// ============================================
// USER ACTIVITY TRACKING - For AI personalization
// ============================================
model UserActivity {
  id          String         @id @default(uuid())
  userId      String?
  sessionId   String
  eventType   UserEventType
  propertyId  String?
  searchQuery String?
  metadata    Json?
  createdAt   DateTime       @default(now())
  
  @@index([userId])
  @@index([sessionId])
  @@index([eventType])
  @@index([createdAt])
}

enum UserEventType {
  SEARCH
  VIEW_LISTING
  VIEW_GALLERY
  CLICK_CONTACT
  ADD_WISHLIST
  COMPARE
  SHARE
  ENQUIRY_SUBMIT
  FILTER_APPLY
  SORT_CHANGE
}

// ============================================
// USER PREFERENCES - Inferred from behavior
// ============================================
model UserPreference {
  id                   String            @id @default(uuid())
  userId               String            @unique
  preferredCategory    PropertyCategory?
  preferredCities      String[]
  preferredPriceMin    Decimal?          @db.Decimal(12, 2)
  preferredPriceMax    Decimal?          @db.Decimal(12, 2)
  preferredBedrooms    Int?
  preferredAmenities   String[]
  buyerType            BuyerType?
  alertsEnabled        Boolean           @default(false)
  updatedAt            DateTime          @updatedAt
}

enum BuyerType {
  INVESTOR
  END_USER
  RETIREE
  FAMILY
  DIGITAL_NOMAD
}

// ============================================
// SEARCH LOGS - For ML training
// ============================================
model SearchLog {
  id            String    @id @default(uuid())
  query         String
  userId        String?
  sessionId     String
  resultsCount  Int
  clickedIds    String[]
  convertedId   String?
  filters       Json?
  createdAt     DateTime  @default(now())
  
  @@index([createdAt])
  @@index([userId])
}
